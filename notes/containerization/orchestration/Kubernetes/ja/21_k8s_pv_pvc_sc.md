# Kubernetes PV、PVC、StorageClass ノート

[English](../en/21_k8s_pv_pvc_sc.md) | [繁體中文](../zh-tw/21_k8s_pv_pvc_sc.md) | [日本語](../ja/21_k8s_pv_pvc_sc.md) | [インデックスに戻る](../README.md)

<img src="../images/21_pv_pvc_sc.jpg" width="700">

## 基本概念

- **Pod**: Kubernetesでアプリケーションを実行する最小単位で、コンテナを含み、ボリューム（ストレージボリューム）をマウントできます。
- **PVC（Persistent Volume Claim）**: PodがPVCを通じてストレージリソースを要求します。「ストレージスペースが欲しい」という申請書に相当します。
- **PV（Persistent Volume）**: 実際にストレージスペースを提供するリソースで、静的（static）または動的（dynamic）に作成できます。

## StorageClass

- **用途**: ストレージリソースのタイプ、パラメータ、動的プロビジョニング方法を定義します。
- **一般的なシナリオ**: PVCがStorageClassを指定すると、KubernetesはそのStorageClassの設定に基づいて、対応するPVを自動的に作成します。
- **例**: 異なるStorageClassを指定して、SSD、HDD、クラウドストレージなどの異なるストレージバックエンドを選択できます。
- **一般的なフィールド**:
  - `provisioner`: どのプラグイン（nfs、csiなど）がストレージを作成するかを指定します。
  - `parameters`: 詳細設定（ストレージサイズ、I/Oタイプなど）。

## Manual create（手動PV作成）

- **用途**: 管理者が事前にPVを作成し、ストレージソース（ローカルディスク、NFSサーバーなど）を指定します。
- **フロー**:
  1. 管理者がPVのYAMLファイルを手動で作成し、クラスターに適用します。
  2. ユーザーがPVCを作成すると、Kubernetesが自動的にPVCを条件に合うPVにバインドします。
- **適用シナリオ**: ストレージリソースソースを正確に制御する必要がある場合や、特別な要件がある場合。

## Provisioner（Dynamic Provisioning、動的プロビジョナー）

- **用途**: StorageClassの設定に基づいて、PVを自動的に作成する責任があります。
- **一般的なProvisioner**:
  - `kubernetes.io/aws-ebs`: AWS EBS
  - `kubernetes.io/gce-pd`: GCP Persistent Disk
  - `nfs.csi.k8s.io`: NFS
  - `csi.azure.com`: Azure Files
- **動作方式**:
  1. ユーザーがPVCを作成し、StorageClassを指定します。
  2. ProvisionerがStorageClass設定に基づいて、自動的にPVを作成し、物理ストレージに接続します。
- **利点**: 自動化、高い柔軟性、クラウドや大規模動的要件に適しています。

## サポートされているストレージバックエンド

- **ローカルストレージ（Local）**: hostPath
- **クラウドストレージ**:
  - AWS EFS
  - GCP Filestore
  - Azure Files
- **その他のプロトコル**:
  - NFS
  - iSCSI
  - CSI（Container Storage Interface）

## フロー概要

1. Podがストレージスペースを必要とし、PVCを提出します。
2. PVCが条件に合うPV（静的または動的）を探します。
3. 動的な場合、StorageClassに基づいてProvisionerが自動的にPVを作成します。
4. PVが実際のストレージバックエンド（ローカルまたはクラウド）に接続します。
5. PodがPVCにバインドし、最終的にPVが提供するストレージスペースにマウントします。

## 分かりやすい比喩

役割
  - Pod（借主）: 住む場所（データを保存する場所）を探したいが、家主が誰か、住所がどこかを知る必要はなく、「賃貸契約」の条件だけを気にします。
  - PVC（賃貸契約）: 借主が要件（スペースサイズ、アクセス権限など）に基づいて書いた賃貸申請書。契約内容が合致すれば、その後はこの契約を使って直接部屋に入ることができます。
  - PV（部屋・倉庫・物理リソース）: 実際の物理スペース（ストレージ）で、背後には様々なハードディスク、NFS、クラウドなどがあります。
  - Kubernetes（仲介・物件管理会社）: 賃貸契約（PVC）に基づいて適切な部屋（PV）をマッチングし、ペアリング完了後は日常管理とメンテナンスを担当します。

動作方式
  - Podは賃貸申請（PVC）を提出するだけで、どのようなスペースが欲しいかを説明すればよいです。
  - Kubernetesがあなたのために適切な部屋（PV）を見つけて/建てて、自動的にマッチングしてくれます。
  - Podは常に賃貸契約（PVC）を通じてドアを開けて部屋に入り、部屋の詳細情報を直接知ることはありません。これにより、後で部屋が変わったり、移転したりしても、Podはアクセス方法を変更する必要がありません。
  - 管理者（Kubernetes）によってリソーススケジューリングが非常に柔軟になり、リソースの回収、移転、拡張も便利になります。

KubernetesのPVC賃貸フローは、日本の賃貸住宅と同じように、仲介（Kubernetes）がすべてを取り仕切り、借主（Pod）は賃貸契約（PVC）だけを管理すれば、家主（PVの背後にあるストレージシステム）が誰かは借主が気にする必要のないことです。