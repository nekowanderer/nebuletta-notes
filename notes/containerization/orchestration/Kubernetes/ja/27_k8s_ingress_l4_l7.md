# Kubernetes Ingress における L4/L7 ネットワーク概念

[English](../en/27_k8s_ingress_l4_l7.md) | [繁體中文](../zh-tw/27_k8s_ingress_l4_l7.md) | [日本語](../ja/27_k8s_ingress_l4_l7.md) | [インデックスに戻る](../README.md)

### OSI ネットワークモデルの基礎

Kubernetes Ingress の L4/L7 概念を議論する前に、OSI ネットワークモデルの基本アーキテクチャを理解することが重要です：

- **Layer 1 (物理層)**：ケーブル、光ファイバーなどの物理的接続
- **Layer 2 (データリンク層)**：MAC アドレス、イーサネットフレーム
- **Layer 3 (ネットワーク層)**：IP アドレス、ルーティング
- **Layer 4 (トランスポート層)**：TCP/UDP プロトコル、ポート
- **Layer 5-6 (セッション/プレゼンテーション層)**：暗号化、圧縮
- **Layer 7 (アプリケーション層)**：HTTP、HTTPS、FTP などのアプリケーションプロトコル

### Layer 4 (L4) ロードバランシング

Layer 4 ロードバランシングはトランスポート層で動作し、以下の特徴があります：

**動作原理：**
- IP アドレスとポートに基づいてルーティング決定を行う
- パケット内容を検査せず、送信元と宛先の情報のみを確認
- TCP/UDP 接続情報を使用して負荷分散を実行

**技術的特徴：**
- **高性能**：高速処理で低レイテンシ
- **プロトコル非依存**：任意の TCP/UDP ベースのトラフィックを処理可能
- **シンプルなルーティング**：ネットワーク情報のみに基づいて転送

**Kubernetes での適用：**
```
外部トラフィック → LoadBalancer Service → IP:Port ベース → バックエンド Pod
```

**使用場面：**
- 高スループットが必要なアプリケーション
- 非 HTTP プロトコルのサービス（データベース、TCP サービスなど）
- シンプルな負荷分散要件

### Layer 7 (L7) ロードバランシング

Layer 7 ロードバランシングはアプリケーション層で動作し、より知的なルーティング能力を持ちます：

**動作原理：**
- HTTP/HTTPS リクエストの完全な内容を検査
- URL パス、ホスト名、リクエストヘッダーなどに基づいてルーティング
- リクエストとレスポンスの内容を変更可能

**技術的特徴：**
- **知的ルーティング**：アプリケーション層情報に基づく複雑なルーティング決定
- **コンテンツ認識**：リクエスト内容に基づいて処理可能
- **プロトコル特化**：主に HTTP/HTTPS トラフィックを処理

**Kubernetes での適用：**
```
HTTP リクエスト → Ingress Controller → Host/Path ベース → 特定の Service → Pod
```

**ルーティング例：**
- `api.example.com/users` → User Service
- `api.example.com/orders` → Order Service
- `admin.example.com/*` → Admin Service

### Kubernetes における設定方法

**L4 サービス（LoadBalancer Service）：**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-app-l4
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: my-app
```

**L7 サービス（Ingress）：**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-app-l7
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /users
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 80
```

### 実際のアプリケーションシナリオの比較

| 考慮事項 | L4 ロードバランシング | L7 ロードバランシング |
|----------|----------------------|----------------------|
| **選択タイミング** | • 最高のパフォーマンスと最低のレイテンシが必要<br>• 非 HTTP プロトコルの処理<br>• シンプルな負荷分散要件<br>• コンテンツベースのルーティングが不要 | • URL パスやホスト名に基づくルーティングが必要<br>• SSL 終端の実装<br>• アプリケーション層のヘルスチェックが必要<br>• リクエストの変更や書き換えを実行<br>• マイクロサービスアーキテクチャの API Gateway の実装 |
| **実際の適用シナリオ** | • データベース接続プール（MySQL、PostgreSQL）<br>• TCP 長時間接続サービス<br>• ゲームサーバー<br>• リアルタイム通信システム | • Web アプリケーションのルーティング<br>• RESTful API のサービス分散<br>• ユーザーベースのルーティング（A/B テスト）<br>• SSL 証明書の一元管理 |

### パフォーマンスと機能のトレードオフ

| 特徴 | L4 ロードバランシング | L7 ロードバランシング |
|------|----------------------|----------------------|
| 処理速度 | 速い | 遅い |
| 機能の豊富さ | 基本的 | 豊富 |
| ルーティングの知性 | シンプル | 複雑 |
| プロトコルサポート | すべての TCP/UDP | 主に HTTP/HTTPS |
| リソース消費 | 低い | 高い |
| 設定の複雑さ | シンプル | 複雑 |

### わかりやすい比喩

| 役割 | 比喩 | チェック項目 | 対応する Ingress レベル |
|------|------|--------------|------------------------|
| 管制ゲート | 「このアクセスカードでこのドアが開けられるか」のみを認識 - フロアと部屋番号を確認 | カード番号、部屋番号 → **IP アドレス + ポート番号**のような | **L4** |
| 受付デスク | さらに「どの部署を訪問するか、予約内容は何か」を確認 - 訪問者情報と目的を確認 | 訪問部署、訪問者名、予約内容 → **HTTP Host、Path、Header**のような | **L7** |

- L4 Ingress：ゲートのように「カード番号がこのドアに合致するか」のみをチェック - TCP/UDP + ポート番号を確認して通す。
- L7 Ingress：受付のようにカードスキャンだけでなく、どの階に行くか、部署名、さらには訪問者フォームの記入まで要求してから転送する。