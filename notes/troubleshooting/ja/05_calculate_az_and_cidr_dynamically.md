# å‹•çš„AZã¨CIDRè¨ˆç®—ã‚¬ã‚¤ãƒ‰

[English](../en/05_calculate_az_and_cidr_dynamically.md) | [ç¹é«”ä¸­æ–‡](../zh-tw/05_calculate_az_and_cidr_dynamically.md) | [æ—¥æœ¬èª](../ja/05_calculate_az_and_cidr_dynamically.md) | [ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«æˆ»ã‚‹](../README.md)

ã“ã®æ–‡æ›¸ã§ã¯ã€Nebulettaãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã‘ã‚‹å‹•çš„Availability Zoneï¼ˆAZï¼‰é¸æŠã¨CIDRãƒ–ãƒ­ãƒƒã‚¯è‡ªå‹•è¨ˆç®—ã®å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

---

## èƒŒæ™¯
- å®Ÿé¨“æ—¥ï¼š2025/07/21
- é›£æ˜“åº¦ï¼šğŸ¤¬
- èª¬æ˜ï¼šåˆæœŸã®å®Ÿè£…ã§ã¯æ‰‹å‹•è¨ˆç®—ã¨è¨­å®šã«å¤§ããä¾å­˜ã—ã¦ãŠã‚Šã€ç†æƒ³çš„ãªè§£æ±ºç­–ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

---

### å¾“æ¥ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰æ–¹å¼
```hcl
# å¤ã„å®Ÿè£…æ–¹æ³•
azs = ["ap-northeast-1a", "ap-northeast-1c"]
public_subnet_cidrs = ["10.0.1.0/24", "10.0.2.0/24"]
private_subnet_cidrs = ["10.0.11.0/24", "10.0.12.0/24"]
```

**å•é¡Œç‚¹ï¼š**
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é–“ã§ä½¿ç”¨ã§ããªã„ï¼ˆå„ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§AZãŒç•°ãªã‚‹ï¼‰
- AZãƒªã‚¹ãƒˆã®æ‰‹å‹•ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå¿…è¦
- CIDRãƒ–ãƒ­ãƒƒã‚¯ã®æ‰‹å‹•è¨ˆç®—ãŒå¿…è¦
- è¨­å®šãƒŸã‚¹ãŒç™ºç”Ÿã—ã‚„ã™ã„

---

## è§£æ±ºç­–ï¼šå‹•çš„è¨ˆç®—

### 1. è‡ªå‹•AZæ¤œå‡º

```hcl
# data.tf
data "aws_availability_zones" "available" {
  state = "available"
  filter {
    name   = "opt-in-status"
    values = ["opt-in-not-required"]
  }
}

# locals.tf
available_azs = slice(
  data.aws_availability_zones.available.names, 
  0, 
  min(var.max_azs, length(data.aws_availability_zones.available.names))
)
```

**é‡è¦æ¦‚å¿µï¼š**
- `state = "available"` - åˆ©ç”¨å¯èƒ½ãªAZã®ã¿ã‚’é¸æŠ
- `opt-in-status = "opt-in-not-required"` - è¿½åŠ ç”³è«‹ä¸è¦ã®AZã®ã¿ã‚’é¸æŠ
- `min()`é–¢æ•°ã§å®Ÿéš›ã«åˆ©ç”¨å¯èƒ½ãªAZæ•°ã‚’è¶…ãˆãªã„ã“ã¨ã‚’ä¿è¨¼

### 2. å‹•çš„CIDRè¨ˆç®—

#### ã‚¹ãƒ†ãƒƒãƒ—1ï¼šVPC CIDRåˆ†è§£
```hcl
vpc_cidr_prefix = split("/", var.vpc_cidr)[0]  # "10.0.0.0"
vpc_cidr_mask   = tonumber(split("/", var.vpc_cidr)[1])  # 16
```

#### ã‚¹ãƒ†ãƒƒãƒ—2ï¼šIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå‡¦ç†
```hcl
# "10.0.0.0" ã‚’ ["10", "0", "0", "0"] ã«åˆ†å‰²
split(".", local.vpc_cidr_prefix)

# æœ€åˆã®2ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ ["10", "0"] ã‚’å–å¾—
slice(split(".", local.vpc_cidr_prefix), 0, 2)

# "10.0" ã«å†çµåˆ
join(".", slice(split(".", local.vpc_cidr_prefix), 0, 2))
```

#### ã‚¹ãƒ†ãƒƒãƒ—3ï¼šã‚µãƒ–ãƒãƒƒãƒˆCIDRç”Ÿæˆ
```hcl
# ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆ: 10.x.1.0/24, 10.x.2.0/24, ...
public_subnet_cidrs = [
  for i in range(length(local.available_azs)) :
  "${join(".", slice(split(".", local.vpc_cidr_prefix), 0, 2))}.${i + 1}.0/24"
]

# ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ: 10.x.11.0/24, 10.x.12.0/24, ...
private_subnet_cidrs = [
  for i in range(length(local.available_azs)) :
  "${join(".", slice(split(".", local.vpc_cidr_prefix), 0, 2))}.${i + 11}.0/24"
]
```

---

## é–¢æ•°è©³ç´°èª¬æ˜

### Terraformé–¢æ•°ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

| é–¢æ•° | ç”¨é€” | ä¾‹ |
|------|------|-----|
| `slice(list, start, end)` | ãƒªã‚¹ãƒˆã‹ã‚‰éƒ¨åˆ†ã‚’æŠ½å‡º | `slice(["a","b","c"], 0, 2)` â†’ `["a","b"]` |
| `split(separator, string)` | æ–‡å­—åˆ—åˆ†å‰² | `split("/", "10.0.0.0/16")` â†’ `["10.0.0.0", "16"]` |
| `join(separator, list)` | ãƒªã‚¹ãƒˆçµåˆ | `join(".", ["10","0"])` â†’ `"10.0"` |
| `tonumber(string)` | æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ› | `tonumber("16")` â†’ `16` |
| `min(a, b)` | ã‚ˆã‚Šå°ã•ã„å€¤ã‚’å–å¾— | `min(4, 3)` â†’ `3` |
| `length(list)` | ãƒªã‚¹ãƒˆã®é•·ã•ã‚’å–å¾— | `length(["a","b"])` â†’ `2` |
| `range(n)` | æ•°å€¤ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç”Ÿæˆ | `range(3)` â†’ `[0, 1, 2]` |

### å®Œå…¨è¨ˆç®—ä¾‹

å‰ææ¡ä»¶ï¼š
- `var.vpc_cidr = "10.0.0.0/16"`
- `var.max_azs = 3`
- ap-northeast-1ã§åˆ©ç”¨å¯èƒ½ãªAZï¼š`["ap-northeast-1a", "ap-northeast-1c", "ap-northeast-1d"]`

**è¨ˆç®—ãƒ—ãƒ­ã‚»ã‚¹ï¼š**

1. **AZé¸æŠï¼š**
   ```hcl
   available_azs = ["ap-northeast-1a", "ap-northeast-1c", "ap-northeast-1d"]
   ```

2. **CIDRåˆ†è§£ï¼š**
   ```hcl
   vpc_cidr_prefix = "10.0.0.0"
   join(".", slice(split(".", "10.0.0.0"), 0, 2)) = "10.0"
   ```

3. **ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆè¨ˆç®—ï¼š**
   ```hcl
   i=0: "10.0.1.0/24"   # ap-northeast-1a
   i=1: "10.0.2.0/24"   # ap-northeast-1c  
   i=2: "10.0.3.0/24"   # ap-northeast-1d
   ```

4. **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆè¨ˆç®—ï¼š**
   ```hcl
   i=0: "10.0.11.0/24"  # ap-northeast-1a
   i=1: "10.0.12.0/24"  # ap-northeast-1c
   i=2: "10.0.13.0/24"  # ap-northeast-1d
   ```

---

## ãƒ¡ãƒªãƒƒãƒˆç·æ‹¬

### âœ… è§£æ±ºã•ã‚ŒãŸå•é¡Œ
1. **ã‚¯ãƒ­ã‚¹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›æ€§** - ä»»æ„ã®AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®AZæ§‹æˆã«è‡ªå‹•é©å¿œ
2. **è¨­å®šè¤‡é›‘åº¦ã®è»½æ¸›** - `max_azs`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æŒ‡å®šã®ã¿ã§æ¸ˆã‚€
3. **äººçš„ãƒŸã‚¹ã®å‰Šæ¸›** - è‡ªå‹•CIDRè¨ˆç®—ã«ã‚ˆã‚Šç«¶åˆã‚’å›é¿
4. **æŸ”è»Ÿãªåˆ¶å¾¡** - è¦ä»¶ã«å¿œã˜ã¦AZæ•°ã‚’èª¿æ•´å¯èƒ½
5. **ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¬ãƒ©ãƒ³ãƒˆæ©Ÿèƒ½** - AZæ•°ä¸è¶³ã®å ´åˆã‚’è‡ªå‹•å‡¦ç†

### âœ… å®Ÿéš›ã®åŠ¹æœ
- **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§å‘ä¸Š** - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰è¨­å®šã‚’å‰Šæ¸›
- **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæŸ”è»Ÿæ€§** - åŒä¸€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ç•°ãªã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«å¯¾å¿œ
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** - AZæ•°ã®èª¿æ•´ãŒç°¡å˜
- **ä¸€è²«æ€§** - CIDRå‰²ã‚Šå½“ã¦ãƒ«ãƒ¼ãƒ«ã®çµ±ä¸€

---

## ç‰¹æ®Šã‚±ãƒ¼ã‚¹èª¬æ˜

### ap-northeast-1ã®å®Ÿéš›ã®çŠ¶æ³
- ç†è«–ä¸Šã¯4ã¤ã®AZï¼ˆaã€bã€cã€dï¼‰
- å®Ÿéš›ã«ã¯3ã¤ã®ã¿åˆ©ç”¨å¯èƒ½ï¼ˆap-northeast-1bã¯å»ƒæ­¢æ¸ˆã¿ï¼‰
- ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•æ¤œå‡ºã—ã¦ä½¿ç”¨ï¼š`["ap-northeast-1a", "ap-northeast-1c", "ap-northeast-1d"]`

### CIDRå‰²ã‚Šå½“ã¦ãƒ«ãƒ¼ãƒ«
- **VPC CIDR**: `10.0.0.0/16`ï¼ˆ65536å€‹ã®IPï¼‰
- **ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆ**: `10.0.1.0/24`ã€`10.0.2.0/24`ã€...ï¼ˆå„256å€‹ã®IPï¼‰
- **ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ**: `10.0.11.0/24`ã€`10.0.12.0/24`ã€...ï¼ˆå„256å€‹ã®IPï¼‰
- **äºˆç´„ã‚¹ãƒšãƒ¼ã‚¹**: `10.0.0.0/24`ã€`10.0.4-10.0/24`ã€`10.0.14+.0/24`ã‚’ä»–ã®ç”¨é€”ã§åˆ©ç”¨å¯èƒ½

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æŸ”è»Ÿæ€§ã¨ä¿å®ˆæ€§ã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™ã€‚
