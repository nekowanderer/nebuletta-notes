# CIDR設計と計算方法

[English](../en/03_how_to_arrange_cidr.md) | [繁體中文](../zh-tw/03_how_to_arrange_cidr.md) | [日本語](../ja/03_how_to_arrange_cidr.md) | [インデックスに戻る](../README.md)

## CIDR基本概念

CIDR (Classless Inter-Domain Routing) は、IPアドレスの配布とルーティングの方法で、ネットワークリソースをより効率的に管理するために使用されます。

### 表記法の解説

```
10.0.0.0/16
    ↑     ↑
   IP   プレフィックス長
```

**プレフィックス長**はネットワーク部分のビット数を表します：
- `/16` = 最初の16ビットがネットワーク部分
- `/24` = 最初の24ビットがネットワーク部分
- `/32` = ホストアドレス（単一IP）

---

## ビット構成と計算

### 1. IPアドレス構造
```
IPアドレス：32ビット = 4バイト

例：10.0.0.0
二進法：00001010.00000000.00000000.00000000
          ↑        ↑        ↑        ↑
        第1バイト  第2バイト  第3バイト  第4バイト
```

### 2. ネットワーク部とホスト部の分割
```
10.0.0.0/16の分割：

ネットワーク部：最初の16ビット (00001010.00000000)
ホスト部：最後の16ビット (.00000000.00000000)

変更可能範囲：10.0.0.0 ~ 10.0.255.255
```

---

## 利用可能IP数計算

### 計算式
**利用可能IP数 = 2^(32-プレフィックス長) - 2**

> **なぜ2を引くのか？**
> - 最初のIP：ネットワークアドレス（使用不可）
> - 最後のIP：ブロードキャストアドレス（使用不可）

### 一般的なCIDR容量表

| CIDR | ネットワークビット | ホストビット | 総IP数 | 利用可能IP数 | 用途 |
|------|-------------------|--------------|---------|---------------|------|
| /16  | 16                | 16           | 65,536  | 65,534        | 大規模ネットワーク |
| /24  | 24                | 8            | 256     | 254           | 一般的なサブネット |
| /25  | 25                | 7            | 128     | 126           | 小規模サブネット |
| /26  | 26                | 6            | 64      | 62            | 微細サブネット |
| /27  | 27                | 5            | 32      | 30            | 極小サブネット |
| /28  | 28                | 4            | 16      | 14            | デバイスグループ |

### 実際の計算例

#### 例1：VPC設計
```
VPC: 10.0.0.0/16

計算過程：
ホストビット：32 - 16 = 16ビット
利用可能IP：2^16 - 2 = 65,534個
IP範囲：10.0.0.1 ~ 10.0.255.254
```

#### 例2：サブネット設計
```
サブネット: 10.0.1.0/24

計算過程：
ホストビット：32 - 24 = 8ビット
利用可能IP：2^8 - 2 = 254個
IP範囲：10.0.1.1 ~ 10.0.1.254
```

---

## サブネット分割計算

### 大規模ネットワークから小規模ネットワークへの分割

#### 例：/16から/24への分割
```
元のネットワーク：10.0.0.0/16

作成可能な/24サブネット数：
2^(24-16) = 2^8 = 256個

サブネットリスト：
10.0.0.0/24    → 10.0.0.1   ~ 10.0.0.254   (254個のIP)
10.0.1.0/24    → 10.0.1.1   ~ 10.0.1.254   (254個のIP)
10.0.2.0/24    → 10.0.2.1   ~ 10.0.2.254   (254個のIP)
...
10.0.255.0/24  → 10.0.255.1 ~ 10.0.255.254 (254個のIP)
```

### サブネット境界チェック

IPが有効なサブネット開始アドレスかどうかをチェック：

```bash
# 10.0.11.0/24が有効かチェック

Step 1: IPアドレス構造の分析
10.0.11.0/24
- ネットワーク部：最初の24ビット (10.0.11)
- ホスト部：最後の8ビット (0)

Step 2: ホスト部が0かチェック
第4バイト = 0 = 00000000
ホスト部がすべて0 ✓

# 結論：10.0.11.0/24は有効なサブネット開始アドレス
```

#### 別の例：無効なケースのチェック
```bash
# 10.0.11.5/24が有効かチェック

Step 1: IPアドレス構造の分析  
10.0.11.5/24
- ネットワーク部：最初の24ビット (10.0.11)
- ホスト部：最後の8ビット (5)

Step 2: ホスト部が0かチェック
第4バイト = 5 = 00000101
ホスト部が0でない ✗

# 結論：10.0.11.5/24は有効なサブネット開始アドレスではない
# 正しいサブネットは：10.0.11.0/24
```

#### より複雑な例：/26サブネットのチェック
```bash
# 10.0.1.64/26が有効かチェック

Step 1: /26の構造分析
/26 = 26ビットネットワーク部 + 6ビットホスト部
ホスト部：最後の6ビットは0でなければならない

Step 2: 第4バイトのチェック
64 = 01000000 (二進法)
最後の6ビット = 000000 ✓ (すべて0)

# 結論：10.0.1.64/26は有効なサブネット

# /26の有効なサブネット境界：
# 10.0.1.0/26   (0   = 00000000)
# 10.0.1.64/26  (64  = 01000000) 
# 10.0.1.128/26 (128 = 10000000)
# 10.0.1.192/26 (192 = 11000000)
```

---

## マルチ環境CIDR設計実践

### 環境分離戦略

推奨されるマルチ環境設計：

```
Dev環境：      10.0.x.x/16  (10.0.0.0   ~ 10.0.255.255)
Staging環境：  10.1.x.x/16  (10.1.0.0   ~ 10.1.255.255)
Production：   10.2.x.x/16  (10.2.0.0   ~ 10.2.255.255)
Testing：      10.3.x.x/16  (10.3.0.0   ~ 10.3.255.255)
```

### 具体的な設計例

#### Dev環境：10.0.0.0/16
```
VPC総容量：65,534個のIP

Publicサブネット：
├── AZ-a: 10.0.1.0/24  → 254個のIP
└── AZ-b: 10.0.2.0/24  → 254個のIP

Privateサブネット：
├── AZ-a: 10.0.11.0/24 → 254個のIP  
└── AZ-b: 10.0.12.0/24 → 254個のIP

Databaseサブネット：
├── AZ-a: 10.0.21.0/24 → 254個のIP
└── AZ-b: 10.0.22.0/24 → 254個のIP

総使用量：6 × 254 = 1,524個のIP
使用率：1,524 / 65,534 = 2.3%
```

#### 完全な環境設計
```
🏗️  Dev環境 (10.0.x.x/16)
├── Public:   10.0.1.0/24,  10.0.2.0/24
├── Private:  10.0.11.0/24, 10.0.12.0/24
└── Database: 10.0.21.0/24, 10.0.22.0/24

🚀 Staging環境 (10.1.x.x/16)
├── Public:   10.1.1.0/24,  10.1.2.0/24
├── Private:  10.1.11.0/24, 10.1.12.0/24
└── Database: 10.1.21.0/24, 10.1.22.0/24

🏭 Production環境 (10.2.x.x/16)
├── Public:   10.2.1.0/24,  10.2.2.0/24
├── Private:  10.2.11.0/24, 10.2.12.0/24
└── Database: 10.2.21.0/24, 10.2.22.0/24
```

---

## 設計の利点と注意事項

### この設計の利点

1. **IP競合の回避**
   - 異なる環境で異なる/16ブロックを使用
   - VPC PeeringやTransit Gateway接続時に競合しない

2. **一貫したパターンの維持**
   - すべての環境で同じサブネット番号規則を採用
   - 記憶と保守が容易

3. **環境の容易な識別**
   ```
   10.0.x.xを見る → Dev環境とわかる
   10.1.x.xを見る → Staging環境とわかる
   10.2.x.xを見る → Production環境とわかる
   ```

4. **十分な拡張スペース**
   - 各環境で65,534個の利用可能IP
   - 再設計なしでより多くのサブネットを追加可能

### 注意事項

1. **十分なスペースの確保**
   ```bash
   # 過度な分割を避ける
   ❌ 悪い例：すべての/24サブネットを使い切る
   ✅ 良い例：必要なサブネットのみ使用し、将来のためにスペースを保留
   ```

2. **ルーティング要件の考慮**
   - 異なるサブネット間の通信ニーズ
   - ルートテーブル複雑度管理

3. **セキュリティグループ設計**
   - CIDR範囲に基づくセキュリティルール設定
   - 最小権限の原則

---

## 実用的なツールとコツ

### 迅速な計算のコツ

```bash
# よく使用される容量を覚える
/16 = 65K個のIP   (VPCに適用)
/24 = 256個のIP   (一般的なサブネットに適用)
/26 = 64個のIP    (小規模マイクロサービスに適用)
/28 = 16個のIP    (データベースクラスターに適用)

# CIDR計算機コマンド
$ ipcalc 10.0.0.0/16
$ sipcalc 10.0.1.0/24
```

### チェックツール
```python
# Python例
import ipaddress

network = ipaddress.IPv4Network('10.0.0.0/16')
print(f"ネットワークアドレス: {network.network_address}")
print(f"ブロードキャストアドレス: {network.broadcast_address}")
print(f"利用可能IP数: {network.num_addresses - 2}")

# サブネットチェック
subnet = ipaddress.IPv4Network('10.0.1.0/24')
print(f"サブネットか: {subnet.subnet_of(network)}")
```

---

## まとめ

良好なCIDR設計により以下が可能：

1. **運用効率の向上**：明確な命名規則と構造
2. **将来の競合回避**：十分なアドレススペースの確保
3. **ネットワーク管理の簡素化**：一貫したアーキテクチャパターン
4. **環境拡張のサポート**：柔軟な成長スペース

覚えておくべきこと：**現在のニーズを設計時に考慮するが、将来のためのスペースも残しておく！**