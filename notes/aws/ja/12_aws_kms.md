# AWS KMS（Key Management Service）について

[English](../en/12_aws_kms.md) | [繁體中文](../zh-tw/12_aws_kms.md) | [日本語](./12_aws_kms.md) | [Back to Index](../README.md)

### KMSとは？

AWS KMSは、データの暗号化に使用する暗号化キーを作成および制御するためのフルマネージドな暗号化キー管理サービスです。KMSは他のAWSサービスと統合されており、これらのサービスに保存されているデータを簡単に暗号化することができます。

### 主な機能

#### 1. キー管理
- 暗号化キーの作成、インポート、ローテーション、削除、管理
- 対称鍵と非対称鍵のサポート
- 自動キーバックアップとバージョン管理
- キーエイリアス機能による管理の容易さ

#### 2. 暗号化操作
- 暗号化と復号化のAPIを提供
- 複数の暗号化アルゴリズムをサポート
- データの暗号化とデータキーの生成が可能
- クロスリージョンキー複製をサポート

#### 3. セキュリティ
- キーはKMSサービスから出ることはない
- ハードウェアセキュリティモジュール（HSM）オプションあり
- 各種セキュリティ標準と規制に準拠
- CloudTrail監査ログをサポート

### ユースケース

#### 1. データ暗号化
- S3オブジェクトの暗号化
- DynamoDBテーブルの暗号化
- EBSボリュームの暗号化
- RDSデータベースの暗号化
- Cognitoユーザープールの暗号化

#### 2. アプリケーション暗号化
- アプリケーションデータの暗号化
- 機密情報の保護
- クロスサービスデータの暗号化

#### 3. コンプライアンス要件
- データ保護規制
- セキュリティ標準への準拠
- 監査証跡

### AWSリソースのKMSポリシー

#### 1. なぜKMSポリシーが必要か？
- どのAWSサービスがKMSキーを使用できるかを制御
- 認可されたサービスのみが暗号化/復号化操作を実行できるようにする
- 最小権限の原則に準拠

#### 2. 一般的なサービスのKMSポリシー例

#### S3サービス
```json
{
  "Sid": "AllowS3UseKey",
  "Effect": "Allow",
  "Principal": {
    "Service": "s3.amazonaws.com"
  },
  "Action": [
    "kms:Encrypt",
    "kms:Decrypt",
    "kms:ReEncrypt*",
    "kms:GenerateDataKey*",
    "kms:DescribeKey"
  ],
  "Resource": "*"
}
```

#### DynamoDBサービス
```json
{
  "Sid": "AllowDynamoDBUseKey",
  "Effect": "Allow",
  "Principal": {
    "Service": "dynamodb.amazonaws.com"
  },
  "Action": [
    "kms:Encrypt",
    "kms:Decrypt",
    "kms:ReEncrypt*",
    "kms:GenerateDataKey*",
    "kms:DescribeKey"
  ],
  "Resource": "*"
}
```

#### 3. ポリシー設定の考慮事項
- 必要な権限のみを付与
- サービス固有のプリンシパルを使用
- 定期的なポリシー設定の監査
- キー使用の監視

### IAMロールのKMSポリシー

#### 1. なぜIAMロールのKMSポリシーが必要か？
- どのユーザー/ロールがKMSキーを使用できるかを制御
- 暗号化/復号化操作の権限を管理
- きめ細かいアクセス制御を実装

#### 2. 一般的なIAMロールポリシー例

##### 管理者ロール
```json
{
  "Sid": "AllowAccountRoot",
  "Effect": "Allow",
  "Principal": {
    "AWS": "arn:aws:iam::ACCOUNT_ID:root"
  },
  "Action": [
    "kms:*"  # 完全な管理権限
  ],
  "Resource": "*"
}
```

##### 開発者ロール
```json
{
  "Sid": "AllowDeveloperAccess",
  "Effect": "Allow",
  "Principal": {
    "AWS": "arn:aws:iam::ACCOUNT_ID:role/DeveloperRole"
  },
  "Action": [
    "kms:Encrypt",
    "kms:Decrypt",
    "kms:ReEncrypt",
    "kms:GenerateDataKey",
    "kms:DescribeKey"
  ],
  "Resource": "*"
}
```

##### SSOユーザーロール
```hcl
{
  "Sid": "AllowSSOUserAccess",
  "Effect": "Allow",
  "Principal": {
    "AWS": [
      "arn:aws:sts::ACCOUNT_ID:assumed-role/SSO_ROLE/user1",
      "arn:aws:sts::ACCOUNT_ID:assumed-role/SSO_ROLE/user2"
    ]
  },
  "Action": [
    "kms:Encrypt",
    "kms:Decrypt",
    "kms:ReEncrypt",
    "kms:GenerateDataKey",
    "kms:DescribeKey"
  ],
  "Resource": "*"
}
```

#### 3. IAMロールポリシーのベストプラクティス

##### 権限レベル
- 管理者：完全な権限（kms:*）
- 開発者：基本的な操作権限
- 一般ユーザー：制限された操作権限

##### セキュリティ考慮事項
- 最小権限の原則に従う
- 定期的な権限設定の監査
- 異常な使用の監視
- 権限の分離を実装

##### ポリシー管理
- グループを使用して権限を管理
- 定期的なキーのローテーション
- すべてのキー操作をログ記録
- 適切なアラートの設定

#### 4. 一般的なユースケース

##### アプリケーション暗号化
- アプリケーションが機密データを暗号化する必要がある
- IAMロールを使用してKMSにアクセス
- 暗号化/復号化ロジックの実装

##### クロスサービス暗号化
- 複数のサービスが同じKMSキーを使用
- IAMロールを通じてアクセスを制御
- データの一貫性を確保

##### コンプライアンス要件
- データ保護規制への準拠
- アクセス制御の実装
- 監査証跡の提供

### KMSキーの使用方法

#### 1. 直接使用と間接使用

##### 直接使用（推奨されない）
- IAMロール/ユーザーを通じてKMS APIに直接アクセス
- 暗号化/復号化ロジックを手動で処理する必要がある
- キーのライフサイクルを管理する必要がある
- セキュリティリスクが高い

##### 間接使用（推奨）
- AWSサービスを通じた自動暗号化/復号化
- 例：
  - S3の自動オブジェクト暗号化
  - DynamoDBの自動データ暗号化
  - EBSの自動ディスク暗号化
- より安全で管理が容易

#### 2. なぜ間接使用が推奨されるのか？

##### セキュリティ
- キーがKMSサービスから出ることはない
- 人的ミスを減らす
- セキュリティリスクを低減
- 最小権限の原則に準拠

##### 利便性
- 自動暗号化/復号化の処理
- 追加のコードが不要
- メンテナンスコストの削減
- コンプライアンス要件への対応が容易

##### コスト効率
- APIコール頻度の削減
- 運用エラーのリスク低減
- モニタリングと監査の簡素化
- リソースの効率的な利用

### コスト考慮事項

#### 1. キーのコスト
- カスタマー管理キー（CMK）：キーあたり月額$1
- AWS管理キー：無料

#### 2. APIコールのコスト
- APIコールあたり$0.03
- 暗号化、復号化、データキー生成などを含む

#### 3. コスト最適化の推奨事項
- 可能な限りAWS管理キーを使用
- キー使用の統合
- 不要なキーローテーションを避ける
- APIコール頻度の監視

### ベストプラクティス

#### 1. キー管理
- キーIDの代わりにキーエイリアスを使用
- 定期的なキーのローテーション
- 適切なIAM権限の使用
- CloudTrailログの有効化

#### 2. セキュリティ
- 最小権限の原則に従う
- 定期的なキー使用の監査
- 異常な活動の監視
- 適切な暗号化アルゴリズムの使用

#### 3. コスト管理
- 適切なキータイプの選択
- APIコールの最適化
- 定期的な使用状況の確認
- 未使用キーの削除

### 制限事項

#### 1. 技術的制限
- キーごとの暗号化データサイズ制限
- APIコール制限
- キー数量制限

#### 2. コスト制限
- キーのコスト
- APIコールのコスト
- データ転送のコスト

### まとめ

AWS KMSは、安全で信頼性が高く、使いやすいキー管理ソリューションを提供します。他のAWSサービスとシームレスに統合され、データ暗号化要件を簡単に実装することができます。コストがかかりますが、セキュリティと利便性を考慮すると、これらのコストは価値があります。実際の運用では、特定のニーズに基づいて適切なキータイプと管理戦略を選択し、ベストプラクティスに従ってセキュリティとコスト効率を確保することが重要です。 